<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorateur GitHub Collaboratif</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Styles conservés pour l'esthétique */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .dark .bg-white { background-color: #1f2937; }
        .dark .text-gray-900 { color: #f9fafb; }
        .dark .bg-gray-50 { background-color: #111827; }
        .dark .bg-gray-100 { background-color: #374151; }
        .dark .text-gray-500 { color: #9ca3af; }
        .dark .border-gray-200 { border-color: #374151; }
        .dark .hover\:bg-gray-100:hover { background-color: #374151; }
        .dark .hover\:bg-indigo-900:hover { background-color: #4338ca; }
        .dark .bg-indigo-200 { background-color: #4f46e5; }
        .dark .bg-indigo-800 { background-color: #3730a3; }
        .dark .bg-gray-700 { background-color: #374151; }
        .dark .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .file-tree-container { max-height: calc(100vh - 8rem); overflow-y: auto; }
        #file-content-area { font-family: 'Consolas', 'Monaco', monospace; min-height: calc(100vh - 12rem); resize: none; }
    </style>
    <script>
        // Simple dark mode toggle
        const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (isDarkMode) {
            document.documentElement.classList.add('dark');
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-50 min-h-screen">

    <script type="module">
        // --- CONFIGURATION GITHUB (À REMPLIR PAR L'UTILISATEUR) ---
        // ATTENTION: Remplacez ces valeurs par votre nom d'utilisateur et le nom du dépôt
        const GITHUB_USERNAME = 'obiey-code'; // Par exemple: 'google'
        const GITHUB_REPO = 'explorateur-github'; // Par exemple: 'gemini-canvas-examples'
        
        // ATTENTION SÉCURITÉ : Ce jeton est maintenant exposé dans le code côté client. 
        // Retirez-le immédiatement après avoir terminé les tests de sauvegarde.
        const GITHUB_TOKEN = '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'; // Insérez votre jeton ici pour les tests d'écriture
        // -----------------------------------------------------------

        // Configuration du projet (arborescence) - Utilise la structure du fichier ARBORESCENCE.txt
        const fileStructureText = `app\\Builders\\Site\\ListSiteSearchBuilder.php
app\\Builders\\Site\\SiteProjectionBuilder.php
app\\Builders\\Tariff\\ListTariffSearchBuilder.php
app\\Builders\\Tariff\\TariffProjectionBuilder.php
app\\Builders\\User\\ListUserSearchBuilder.php
app\\Builders\\User\\UserProjectionBuilder.php
app\\Builders\\VehicleType\\ListVehicleTypeSearchBuilder.php
app\\Builders\\VehicleType\\VehicleTypeProjectionBuilder.php
app\\Enumerations\\EventType.php
app\\Enumerations\\PassageDirection.php
app\\Enumerations\\PaymentStatus.php
app\\Enumerations\\TariffPlanType.php
app\\Enumerations\\TollSubscriberType.php
app\\Enumerations\\UserRole.php
app\\ExportsExcel\\UsersListExport.php
app\\Http\\Controllers\\AuthenticationController.php
app\\Http\\Controllers\\Controller.php
app\\Http\\Controllers\\EventHistoryController.php
app\\Http\\Controllers\\SiteController.php
app\\Http\\Controllers\\SubscriptionController.php
app\\Http\\Controllers\\TariffController.php
app\\Http\\Controllers\\UserController.php
app\\Http\\Controllers\\VehiclePassController.php
app\\Http\\Controllers\\VehicleTypeController.php
app\\Http\\Middleware\\CheckRoleMiddleware.php
app\\Http\\Middleware\\ShouldChangePasswordMiddleware.php
app\\Http\\Requests\\CommonFormRequest.php
app\\Http\\Requests\\SearchFormRequest.php
app\\Http\\Requests\\Authentication\\CurrentUserRequest.php
app\\Http\\Requests\\Authentication\\LoginRequest.php
app\\Http\\Requests\\Authentication\\LogoutRequest.php
app\\Http\\Requests\\Site\\ActivateSiteStatusRequest.php
app\\Http\\Requests\\Site\\AllSiteRequest.php
app\\Http\\Requests\\Site\\DeactivateSiteStatusRequest.php
app\\Http\\Requests\\Site\\ListSiteRequest.php
app\\Http\\Requests\\Site\\SaveSiteRequest.php
app\\Http\\Requests\\Tariff\\ActivateTariffStatusRequest.php
app\\Http\\Requests\\Tariff\\AllTariffRequest.php
app\\Http\\Requests\\Tariff\\DeactivateTariffStatusRequest.php
app\\Http\\Requests\\Tariff\\ListTariffRequest.php
app\\Http\\Requests\\Tariff\\SaveTariffRequest.php
app\\Http\\Requests\\User\\ActivateUserStatusRequest.php
app\\Http\\Requests\\User\\AllUserRequest.php
app\\Http\\Requests\\User\\DeactivateUserStatusRequest.php
app\\Http\\Requests\\User\\ForceChangePasswordRequest.php
app\\Http\\Requests\\User\\ListUserRequest.php
app\\Http\\Requests\\User\\ProfileChangePasswordRequest.php
app\\Http\\Requests\\User\\ProfileUpdateRequest.php
app\\Http\\Requests\\User\\SaveUserRequest.php
app\\Http\\Requests\\VehicleType\\AllVehicleTypeRequest.php
app\\Http\\Requests\\VehicleType\\ListVehicleTypeRequest.php
app\\Models\\BaseModel.php
app\\Models\\EventHistory.php
app\\Models\\Payment.php
app\\Models\\Site.php
app\\Models\\Subscription.php
app\\Models\\Tariff.php
app\\Models\\TollPassage.php
app\\Models\\TollSubscriber.php
app\\Models\\User.php
app\\Models\\Vehicle.php
app\\Models\\VehicleType.php
app\\Models\\scripts\\bootstrap\\sites.sql
app\\Models\\scripts\\bootstrap\\users.sql
app\\Models\\scripts\\bootstrap\\vehicle_types.sql
app\\Providers\\AppServiceProvider.php
app\\Providers\\RouteServiceProvider.php
app\\Services\\EventHistoryService.php
app\\Services\\SiteService.php
app\\Services\\SubscriptionService.php
app\\Services\\TariffService.php
app\\Services\\TollPassageService.php
app\\Services\\TooSubscriberService.php
app\\Services\\VehicleService.php
app\\Services\\VehicleTypeService.php
app\\Services\\Authentication\\AuthenticationService.php
app\\Services\\Authentication\\UserRoleService.php
app\\Services\\Authentication\\UserService.php
app\\Services\\Common\\ErrorService.php
app\\Services\\Common\\FileService.php
app\\Services\\Common\\GeneratorService.php
app\\Services\\Common\\InputService.php
app\\Services\\Common\\MailService.php
app\\Services\\Common\\NumberService.php
app\\Services\\Common\\QrCodeService.php
app\\Traits\\HasModelUUID.php
bootstrap\\app.php
bootstrap\\providers.php
bootstrap\\cache\\.gitignore
config\\app.php
config\\auth.php
config\\cache.php
config\\cors.php
config\\database.php
config\\dompdf.php
config\\excel.php
config\\filesystems.php
config\\logging.php
config\\mail.php
config\\queue.php
config\\request-docs.php
config\\sanctum.php
config\\services.php
config\\session.php
database\\.gitignore
database\\factories\\UserFactory.php
database\\migrations\\0000_01_01_000001_create_sites_table.php
database\\migrations\\0001_01_01_000000_create_users_table.php
database\\migrations\\0001_01_01_000001_create_cache_table.php
database\\migrations\\0001_01_01_000002_create_jobs_table.php
database\\migrations\\2025_08_02_171914_create_vehicle_types_table.php
database\\migrations\\2025_08_04_202112_create_toll_subscriber_table.php
database\\migrations\\2025_08_04_202127_create_vehicles_table.php
database\\migrations\\2025_08_19_111411_create_tariffs_table.php
database\\migrations\\2025_08_19_111421_create_subscriptions_table.php
database\\migrations\\2025_08_19_112500_create_personal_access_tokens_table.php
database\\migrations\\2025_09_02_113203_create_toll_passage_table.php
database\\migrations\\2025_09_03_134432_create_event_histories_table.php
database\\migrations\\2025_09_04_174050_create_payment_table.php
database\\seeders\\DatabaseSeeder.php
database\\seeders\\SiteSeeder.php
database\\seeders\\TarifSeeder.php
database\\seeders\\UserSeeder.php
public\\.htaccess
public\\favicon.ico
public\\index.php
public\\robots.txt
resources\\css\\app.css
resources\\js\\app.js
resources\\js\\bootstrap.js
resources\\views\\welcome.blade.php
routes\\api.php
routes\\console.php
routes\\web.php
storage\\app\\.gitignore
storage\\app\\private\\.gitignore
storage\\app\\public\\.gitignore
storage\\framework\\.gitignore
storage\\framework\\cache\\.gitignore
storage\\framework\\cache\\data\\.gitignore
storage\\framework\\sessions\\.gitignore
storage\\framework\\testing\\.gitignore
storage\\framework\\views\\.gitignore
storage\\logs\\.gitignore
tests\\TestCase.php
tests\\Feature\\ExampleTest.php
tests\\Unit\\ExampleTest.php
.editorconfig
.env.example
.gitattributes
.gitignore
artisan
composer.json
composer.lock
package-lock.json
package.json
phpunit.xml
README.md
vite.config.js`;

        // État de l'application
        const state = {
            currentFile: null, 
            fileContents: {}, // Cache local du contenu des fichiers
            treeData: {}, 
            errorMessage: null,
            loading: true,
            saving: false,
            // Pour GitHub, nous avons besoin du SHA (Hash) du fichier pour pouvoir le mettre à jour.
            fileSHA: null 
        };

        // DOM Elements
        const fileTreeContainer = document.getElementById('file-tree');
        const editorContainer = document.getElementById('editor-container');
        const fileNameDisplay = document.getElementById('file-name-display');
        const fileContentArea = document.getElementById('file-content-area');
        const saveButton = document.getElementById('save-button');
        const statusMessage = document.getElementById('status-message');
        const repoInfoDisplay = document.getElementById('repo-info-display');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessageDisplay = document.getElementById('error-message');


        // --- GitHub Utilities ---

        const GITHUB_API_BASE = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/`;

        /**
         * Tente de parser le corps d'une réponse Fetch. Gère les erreurs de parsing JSON.
         * @param {Response} response La réponse Fetch.
         * @returns {Promise<object|string>} Le corps parsé ou la chaîne d'erreur.
         */
        const parseResponse = async (response) => {
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.includes("application/json")) {
                try {
                    return await response.json();
                } catch (e) {
                    console.error("Erreur de parsing JSON malgré le Content-Type: application/json. Tentative de lecture en texte.", e);
                    return await response.text();
                }
            } else {
                return await response.text();
            }
        };


        /**
         * Récupère le contenu d'un fichier depuis GitHub.
         * Simule l'écoute Firestore (onSnapshot) pour la lecture.
         * @param {string} filePath - Le chemin du fichier (ex: 'app/Http/Controllers/Controller.php').
         */
        const fetchFileContent = async (filePath) => {
            if (!filePath) return;

            // Masquer les erreurs précédentes de l'éditeur
            state.errorMessage = null;

            try {
                // 1. Récupération du contenu brut
                const response = await fetch(GITHUB_API_BASE + filePath, {
                    headers: {
                        'Accept': 'application/vnd.github.v3.raw', // Pour obtenir le contenu brut
                        ...(GITHUB_TOKEN && { 'Authorization': `token ${GITHUB_TOKEN}` })
                    }
                });

                if (response.ok) {
                    // Contenu brut réussi (texte)
                    const content = await response.text();
                    
                    // 2. Récupérer le SHA (nécessaire pour la sauvegarde)
                    // Cette requête doit demander du JSON (Content-Type par défaut)
                    const shaResponse = await fetch(GITHUB_API_BASE + filePath, {
                        headers: {
                            'Accept': 'application/vnd.github.v3+json',
                            ...(GITHUB_TOKEN && { 'Authorization': `token ${GITHUB_TOKEN}` })
                        }
                    });

                    if (shaResponse.ok) {
                        const shaData = await parseResponse(shaResponse); // Doit être JSON
                        state.fileSHA = shaData.sha;
                    } else {
                        // Gérer l'échec de récupération du SHA
                        const shaError = await parseResponse(shaResponse);
                        throw new Error(`Échec de la récupération du SHA. Code: ${shaResponse.status}. Message: ${typeof shaError === 'object' && shaError.message ? shaError.message : 'Réponse non JSON.'}`);
                    }

                    return content;

                } else {
                    // La première requête a échoué (404, 401, etc.)
                    const errorBody = await parseResponse(response);
                    
                    let message = `Code: ${response.status}. `;
                    if (typeof errorBody === 'object' && errorBody.message) {
                        message += `Message GitHub: ${errorBody.message}`;
                    } else if (typeof errorBody === 'string') {
                        // C'est ici que l'HTML (ou le texte brut non JSON) est détecté
                        message += `Le serveur a retourné une erreur non JSON. Contenu: ${errorBody.substring(0, 50)}...`;
                    } else {
                        message += 'Erreur inconnue lors du chargement.';
                    }

                    throw new Error(message);
                }

            } catch (error) {
                renderError(`Impossible de charger le contenu du fichier depuis GitHub. Erreur: ${error.message}`);
                return `Impossible de charger le contenu du fichier depuis GitHub. Erreur: ${error.message}`;
            }
        };

        /**
         * Met à jour le contenu d'un fichier dans GitHub via l'API.
         * Simule la sauvegarde Firestore (setDoc).
         */
        const saveFileContent = async () => {
            if (!state.currentFile || state.saving || !GITHUB_TOKEN) {
                if (!GITHUB_TOKEN) {
                    renderStatus('Erreur: Jeton GitHub (GITHUB_TOKEN) manquant pour la sauvegarde.', 'text-red-500');
                }
                return;
            }
            if (!state.fileSHA) {
                 renderStatus('Erreur: Hash SHA du fichier manquant. Rechargez le fichier.', 'text-red-500');
                 return;
            }

            state.saving = true;
            renderStatus('Sauvegarde GitHub en cours (Commit)...', 'text-yellow-500');

            try {
                const content = fileContentArea.value;
                const base64Content = btoa(unescape(encodeURIComponent(content))); // Convertir en base64
                
                const payload = {
                    message: `Mise à jour collaborative du fichier: ${state.currentFile}`,
                    content: base64Content,
                    sha: state.fileSHA, // SHA actuel du fichier
                    branch: 'main' // Dépot par défaut
                };

                const response = await fetch(GITHUB_API_BASE + state.currentFile, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const result = await parseResponse(response); // Doit être JSON
                    
                    // Mise à jour du SHA pour les prochaines mises à jour
                    state.fileSHA = result.content.sha;
                    
                    renderStatus('Sauvegardé sur GitHub avec succès !', 'text-green-500');

                    // La lecture n'est pas "temps réel" comme Firestore, donc on met à jour le cache
                    state.fileContents[state.currentFile] = content;

                } else {
                    const errorBody = await parseResponse(response);
                     let message = `Code: ${response.status}. `;
                    if (typeof errorBody === 'object' && errorBody.message) {
                        message += `Message GitHub: ${errorBody.message}`;
                    } else if (typeof errorBody === 'string') {
                        message += `Le serveur a retourné une erreur non JSON. Contenu: ${errorBody.substring(0, 50)}...`;
                    } else {
                        message += 'Erreur inconnue lors du commit.';
                    }
                    throw new Error(message);
                }
            } catch (error) {
                console.error("Erreur lors de la sauvegarde du contenu du fichier sur GitHub:", error);
                renderStatus('Erreur de sauvegarde GitHub : ' + error.message, 'text-red-500');
            } finally {
                state.saving = false;
                setTimeout(() => renderStatus('', ''), 5000); 
                renderApp();
            }
        };

        // --- Tree View Logic (Identique à la version Firebase) ---

        /**
         * Convertit la liste de chemins de fichiers en une structure d'arborescence.
         */
        const buildFileTree = () => {
            const tree = {};
            const lines = fileStructureText.trim().split('\n').map(line => line.trim().replace(/\\/g, '/')); // Normaliser les chemins

            lines.forEach(line => {
                const parts = line.split('/');
                let current = tree;
                let fullPath = '';

                parts.forEach((part, index) => {
                    fullPath += (fullPath ? '/' : '') + part;

                    if (!current[part]) {
                        current[part] = {
                            name: part,
                            path: fullPath,
                            children: {},
                            isFile: index === parts.length - 1
                        };
                    }
                    current = current[part].children;
                });
            });
            state.treeData = tree;
        };

        /**
         * Rend l'arborescence des fichiers dans le DOM.
         */
        const renderTree = (node, level = 0) => {
            let html = '';

            for (const key in node) {
                if (Object.hasOwnProperty.call(node, key)) {
                    const item = node[key];
                    const isFile = item.isFile;
                    const childrenKeys = Object.keys(item.children);
                    const isFolder = !isFile && childrenKeys.length > 0;
                    const indentation = level * 4; 

                    if (isFile) {
                        html += `
                            <div class="file-item pl-${indentation} py-1 text-sm flex items-center cursor-pointer hover:bg-indigo-100 dark:hover:bg-indigo-900 transition-colors ${state.currentFile === item.path ? 'bg-indigo-200 dark:bg-indigo-800 font-semibold' : ''}" data-path="${item.path}">
                                <svg class="w-4 h-4 mr-2 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <span>${item.name}</span>
                            </div>
                        `;
                    } else if (isFolder) {
                        const folderId = `folder-${item.path.replace(/[^a-zA-Z0-9]/g, '_')}`;
                        const isOpen = fileTreeContainer.querySelector(`#${folderId}`)?.classList.contains('open') ?? (level < 2); 

                        html += `
                            <div class="folder-item pl-${indentation} py-1 text-sm font-medium flex items-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors select-none ${isOpen ? 'open' : ''}" data-folder-path="${item.path}" data-folder-id="${folderId}">
                                <svg class="w-4 h-4 mr-2 transform transition-transform ${isOpen ? 'rotate-90' : 'rotate-0'}" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                                <svg class="w-4 h-4 mr-2 text-yellow-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"></path></svg>
                                <span>${item.name}</span>
                            </div>
                            <div id="${folderId}" class="folder-content ${isOpen ? 'block' : 'hidden'}">
                                ${renderTree(item.children, level + 1)}
                            </div>
                        `;
                    }
                }
            }
            return html;
        };


        // --- Core Application Logic & Rendering ---

        /**
         * Met à jour l'état de l'interface utilisateur.
         */
        const renderApp = () => {
            loadingIndicator.classList.toggle('hidden', !state.loading);
            errorMessageDisplay.textContent = state.errorMessage || '';
            errorMessageDisplay.classList.toggle('hidden', !state.errorMessage);

            // Mise à jour de l'affichage du dépôt
            repoInfoDisplay.innerHTML = `<span class="font-semibold">Dépôt:</span> ${GITHUB_USERNAME}/${GITHUB_REPO}`;

            if (fileTreeContainer) {
                fileTreeContainer.innerHTML = renderTree(state.treeData);
            }

            if (state.currentFile) {
                fileNameDisplay.textContent = state.currentFile + (state.fileContents[state.currentFile] !== fileContentArea.value ? ' * (modifié localement)' : '');
                editorContainer.classList.remove('hidden');
                fileContentArea.value = state.fileContents[state.currentFile] || '';
                saveButton.disabled = state.saving || !GITHUB_TOKEN;
            } else {
                editorContainer.classList.add('hidden');
                fileNameDisplay.textContent = '';
            }
        };

        const renderStatus = (message, colorClass) => {
            statusMessage.textContent = message;
            statusMessage.className = `p-1 rounded-md text-xs text-center font-medium ${colorClass}`;
            if (message === 'Sauvegardé sur GitHub avec succès !') {
                // Clear modification indicator on successful save
                fileNameDisplay.textContent = state.currentFile;
            }
        };

        const renderError = (message) => {
            state.errorMessage = message;
            console.error(message);
            renderApp();
        };

        /**
         * Gère la sélection d'un fichier et déclenche la récupération GitHub.
         * @param {string} filePath - Le chemin du fichier sélectionné.
         */
        const selectFile = async (filePath) => {
            if (state.currentFile === filePath) return; 

            state.currentFile = filePath;
            state.fileSHA = null; // Réinitialiser le SHA
            
            // Afficher l'éditeur et l'indicateur de chargement
            editorContainer.classList.remove('hidden');
            fileContentArea.value = 'Chargement du contenu depuis GitHub...';
            fileContentArea.disabled = true;
            saveButton.disabled = true;
            renderStatus('Chargement...', 'text-gray-500');

            renderApp(); // Mise à jour de l'arborescence

            const content = await fetchFileContent(filePath);
            
            // Si le fichier n'a pas changé pendant le chargement
            if (state.currentFile === filePath) {
                state.fileContents[filePath] = content;
                fileContentArea.value = content;
                fileContentArea.disabled = false;
                renderStatus('Fichier chargé. Pensez à "Sauvegarder" après modification.', 'text-green-600');
                if (!GITHUB_TOKEN) {
                    renderStatus('ATTENTION: Jeton GitHub manquant. La lecture fonctionne, mais la sauvegarde est désactivée.', 'text-red-500 font-bold');
                }
            }
        };

        // --- Event Handlers ---

        document.addEventListener('click', (event) => {
            const fileItem = event.target.closest('.file-item');
            if (fileItem) {
                const path = fileItem.dataset.path;
                selectFile(path);
                return;
            }

            const folderItem = event.target.closest('.folder-item');
            if (folderItem) {
                const folderId = folderItem.dataset.folderId;
                const folderContent = document.getElementById(folderId);
                const arrowIcon = folderItem.querySelector('svg:first-child');

                if (folderContent && arrowIcon) {
                    const isOpen = folderContent.classList.contains('block');
                    folderContent.classList.toggle('block', !isOpen);
                    folderContent.classList.toggle('hidden', isOpen);
                    arrowIcon.classList.toggle('rotate-90', !isOpen);
                    arrowIcon.classList.toggle('rotate-0', isOpen);
                    folderItem.classList.toggle('open', !isOpen);
                }
            }

            if (event.target === saveButton) {
                saveFileContent();
            }
        });

        // Met à jour l'indicateur de modification locale
        fileContentArea.addEventListener('input', () => {
            if (state.currentFile) {
                // Mettre à jour uniquement l'affichage (l'état réel est mis à jour à la sauvegarde)
                fileNameDisplay.textContent = state.currentFile + ' * (modifié localement)';
            }
        });

        // --- Initialization ---

        const initializeApp = () => {
            state.loading = false;
            
            renderApp();
            
            if (!GITHUB_TOKEN) {
                renderStatus('ATTENTION: Jeton GitHub manquant. La lecture fonctionne (si le dépôt est public), mais la sauvegarde est désactivée.', 'text-red-500 font-bold');
            } else {
                 renderStatus('Configuration GitHub active. Tentative de lecture/écriture possible.', 'text-green-600 font-bold');
            }
        };

        // Démarrer l'application
        buildFileTree();
        initializeApp();
    </script>

    <div class="p-4 bg-white dark:bg-gray-800 shadow-md sticky top-0 z-10 border-b border-gray-200 dark:border-gray-700">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">Explorateur GitHub Collaboratif</h1>
            <div id="user-info" class="text-xs text-gray-500 dark:text-gray-400">
                <p id="repo-info-display">Configuration du dépôt requise...</p>
            </div>
        </div>
    </div>

    <div class="container mx-auto flex flex-col md:flex-row p-4 gap-4">

        <!-- Colonne de l'Arborescence -->
        <div class="w-full md:w-1/3 lg:w-1/4 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
            <h2 class="text-lg font-semibold p-4 border-b border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300">
                Arborescence du Projet (Statique)
            </h2>
            <div id="file-tree" class="file-tree-container p-2 text-gray-700 dark:text-gray-300">
                <!-- Arborescence injectée ici par JavaScript -->
            </div>
        </div>

        <!-- Colonne de l'Éditeur -->
        <div id="editor-wrapper" class="w-full md:w-2/3 lg:w-3/4">

            <div id="loading-indicator" class="flex justify-center items-center h-full text-indigo-500 hidden">
                <svg class="animate-spin -ml-1 mr-3 h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Chargement...
            </div>

            <p id="error-message" class="text-red-500 p-4 font-semibold hidden"></p>

            <div id="editor-container" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 hidden">
                <div class="flex justify-between items-center p-3 border-b border-gray-200 dark:border-gray-700">
                    <h3 id="file-name-display" class="text-md font-mono text-gray-700 dark:text-gray-300 truncate"></h3>
                    <div class="flex items-center space-x-2">
                        <div id="status-message" class="p-1 rounded-md text-xs"></div>
                        <button id="save-button" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center shadow-md">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v8a2 2 0 002 2h14a2 2 0 002-2v-2m-3-10l-3-3m0 0l-3 3m3-3v12"></path></svg>
                            Sauvegarder (Commit)
                        </button>
                    </div>
                </div>

                <textarea id="file-content-area" class="w-full p-4 border-none outline-none bg-white dark:bg-gray-800 text-sm leading-relaxed"></textarea>
            </div>
            <div class="mt-4 p-4 bg-yellow-100 border border-yellow-300 text-yellow-800 rounded-xl dark:bg-gray-700 dark:border-gray-600 dark:text-yellow-300">
                <p class="font-bold">Note Importante :</p>
                <p>Le dépôt est configuré pour: <span class="font-mono text-gray-900 dark:text-white">${GITHUB_USERNAME}/${GITHUB_REPO}</span></p>
                <ul class="list-disc list-inside ml-4 mt-2 text-sm">
                    <li>La lecture des fichiers devrait fonctionner si le dépôt est public.</li>
                    <li>Le bouton **Sauvegarder** est actif car un jeton est fourni.</li>
                </ul>
                <p class="mt-2 text-xs font-bold text-red-600 dark:text-red-400">AVERTISSEMENT SÉCURITÉ : Ce jeton est exposé. Veuillez le retirer une fois les tests terminés.</p>
            </div>
        </div>

    </div>
</body>
</html>